# 五险一金计算器 - 项目上下文管理中枢

## 项目概述

这是一个迷你的"五险一金"计算器 Web 应用，核心功能是根据预设的员工工资数据和城市社保标准，计算出公司为每位员工应缴纳的社保公积金费用，并将结果清晰地展示出来。

---

## 技术栈

| 技术层 | 技术选型 |
|--------|----------|
| 前端框架 | Next.js (App Router) |
| UI/样式 | Tailwind CSS |
| 数据库/后端 | Supabase (PostgreSQL) |
| Excel处理 | xlsx 库 |
| HTTP客户端 | Supabase JS Client |

---

## 数据库设计 (Supabase)

### 1. cities 表（城市标准表）

存储各城市的社保公积金缴纳标准数据。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键，自增 |
| city_name | text | 城市名（如"佛山"） |
| year | text | 年份（如"2024"） |
| base_min | int | 社保基数下限 |
| base_max | int | 社保基数上限 |
| rate | float | 简化的综合缴纳比例（如 0.15 表示 15%） |

### 2. salaries 表（员工工资表）

存储每位员工每月的工资数据。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键，自增 |
| employee_id | text | 员工工号 |
| employee_name | text | 员工姓名 |
| month | text | 年份月份，格式为 YYYYMM（如"202401"） |
| salary_amount | int | 该月工资金额 |

### 3. results 表（计算结果表）

存储社保公积金计算结果。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键，自增 |
| employee_name | text | 员工姓名 |
| avg_salary | float | 年度月平均工资 |
| contribution_base | float | 最终缴费基数 |
| company_fee | float | 公司缴纳金额 |
| calculated_at | timestamp | 计算时间 |

---

## 核心业务逻辑

### 计算函数执行步骤

1. **读取工资数据**
   - 从 `salaries` 表中读取所有数据

2. **计算年度月平均工资**
   - 按员工姓名 (`employee_name`) 分组
   - 计算每位员工的"年度月平均工资"

3. **获取城市标准**
   - 从 `cities` 表中获取佛山的 `year`、`base_min`、`base_max` 和 `rate`

4. **确定最终缴费基数**
   - 对于每位员工，将其"年度月平均工资"与佛山的基数上下限进行比较
   - 规则：
     - 低于下限 → 使用下限
     - 高于上限 → 使用上限
     - 在中间 → 使用平均工资本身

5. **计算公司应缴纳金额**
   - 公式：`公司应缴纳金额 = 最终缴费基数 × rate`

6. **存储计算结果**
   - 将每位员工的计算结果存入 `results` 表

---

## 前端页面功能

### 1. `/` 主页

**定位**：应用的入口页面和导航中枢

**布局**：两个并排或垂直排列的功能卡片

| 卡片 | 标题 | 说明 | 跳转 |
|------|------|------|------|
| 卡片一 | 数据上传 | 上传员工工资和城市标准数据 | `/upload` |
| 卡片二 | 结果查询 | 查看社保公积金计算结果 | `/results` |

---

### 2. `/upload` 上传页

**定位**：后台操作的控制面板，用于数据准备和计算触发

**功能**：

| 功能 | 说明 |
|------|------|
| **上传数据** | 从本地选择两个独立的 Excel 文件：<br>• cities.xlsx → 插入 cities 表<br>• salaries.xlsx → 插入 salaries 表 |
| **执行计算并存储结果** | 触发核心计算逻辑，将结果存入 results 表 |
| **清空数据表** | 提供按钮清空 salaries、cities、results 表的数据 |

---

### 3. `/results` 结果页

**定位**：计算成果的最终展示页面

**功能**：

| 功能 | 说明 |
|------|------|
| **自动加载数据** | 页面加载时自动从 results 表获取所有计算结果 |
| **表格展示** | 使用 Tailwind CSS 样式化表格，展示所有字段：<br>• 员工姓名<br>• 年度月平均工资<br>• 最终缴费基数<br>• 公司缴纳金额<br>• 计算时间 |

**表格列结构**：

| 员工姓名 | 年度月平均工资 | 最终缴费基数 | 公司缴纳金额 | 计算时间 |
|----------|----------------|--------------|--------------|----------|
| ... | ... | ... | ... | ... |

---

## TodoList - 开发任务清单

### 阶段一：环境初始化与配置

- [ ] 创建 Next.js 项目（使用 `create-next-app`，选择 App Router、TypeScript、Tailwind CSS）
- [ ] 安装项目依赖（supabase-js、xlsx、@tanstack/react-query）
- [ ] 配置 Tailwind CSS
- [ ] 在 Supabase 创建项目并获取项目 URL 和 Anon Key
- [ ] 创建 `.env.local` 文件，配置环境变量

### 阶段二：Supabase 数据库设置

- [ ] 在 Supabase SQL Editor 中创建 `cities` 表
- [ ] 在 Supabase SQL Editor 中创建 `salaries` 表
- [ ] 在 Supabase SQL Editor 中创建 `results` 表
- [ ] 配置 Row Level Security (RLS) 策略（可选，根据需求）
- [ ] 创建 Supabase 客户端工具文件（`lib/supabase/client.ts`、`lib/supabase/server.ts`）

### 阶段三：核心计算逻辑实现

- [ ] 创建计算函数文件（`lib/calculation.ts`）
- [ ] 实现"读取 salaries 表所有数据"功能
- [ ] 实现"按员工分组计算年度月平均工资"功能
- [ ] 实现"获取佛山城市标准"功能
- [ ] 实现"确定最终缴费基数"功能（含基数上下限比较逻辑）
- [ ] 实现"计算公司应缴纳金额"功能
- [ ] 实现"存储计算结果到 results 表"功能

### 阶段四：主页开发 (`/`)

- [ ] 创建主页页面文件（`app/page.tsx`）
- [ ] 实现页面布局（容器、标题）
- [ ] 实现功能卡片一（数据上传卡片 + 链接）
- [ ] 实现功能卡片二（结果查询卡片 + 链接）
- [ ] 使用 Tailwind CSS 进行样式美化

### 阶段五：上传页开发 (`/upload`)

- [ ] 创建上传页文件（`app/upload/page.tsx`）
- [ ] 实现"上传数据"区域（两个文件选择器）
- [ ] 实现 Excel 文件解析逻辑（使用 xlsx 库）
- [ ] 实现 cities 数据插入 Supabase 逻辑
- [ ] 实现 salaries 数据插入 Supabase 逻辑
- [ ] 实现"执行计算并存储结果"按钮
- [ ] 实现"清空数据表"按钮（支持清空单个表或全部）
- [ ] 添加操作反馈（成功/失败提示）

### 阶段六：结果页开发 (`/results`)

- [ ] 创建结果页文件（`app/results/page.tsx`）
- [ ] 实现"自动加载数据"功能（从 results 表获取所有数据）
- [ ] 实现表格组件（使用 Tailwind CSS）
- [ ] 实现表格数据展示逻辑
- [ ] 添加空数据状态展示
- [ ] 添加刷新数据功能（可选）

### 阶段七：测试与优化

- [ ] 准备测试数据（cities.xlsx、salaries.xlsx）
- [ ] 测试数据上传功能
- [ ] 测试计算逻辑正确性
- [ ] 测试结果展示功能
- [ ] 测试清空数据表功能
- [ ] 修复发现的 bug
- [ ] 代码格式化和注释补充（如需要）

### 阶段八：文档与部署（可选）

- [ ] 编写 README.md 使用说明
- [ ] 配置部署（Vercel/其他平台）
- [ ] 测试生产环境功能

---

## 重要注意事项

### 固定规则

1. **城市固定使用佛山**：计算时无需城市选择，固定读取 `city_name = '佛山'` 的数据
2. **Excel 文件分离**：cities 和 salaries 数据通过两个独立的 Excel 文件上传
3. **无分页需求**：结果页一次性展示所有计算结果，无需分页
4. **城市标准结构**：使用简化的综合缴纳比例，而非拆分各项社保比例

### 数据流程图

```
Excel 文件
   ↓
[上传页] → 解析 → cities 表 / salaries 表
   ↓
[执行计算] → 读取 salaries → 计算平均工资
   ↓
[读取佛山标准] → 确定缴费基数
   ↓
[计算缴纳金额] → 存入 results 表
   ↓
[结果页] → 展示表格
```

---

## 最后更新时间

2026-02-15
